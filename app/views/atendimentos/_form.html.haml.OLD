= render 'layouts/errors', object: @atendimento
		
.container-fluid
	- if params[:date]
		- if !(@atendimento.funcionario.diaDeTrabalho?(params[:date]))
			%h4
				.alert.alert-error
					%a.close{"data-dismiss"=>"alert"}
						&#215
					Funcionário não atende na(o)
					= params[:date]
					%small
						\-
						tente outro dia
		- if (@atendimento.funcionario.agendaLotada?(params[:date]))
			%h4
				.alert.alert-error
					%a.close{"data-dismiss"=>"alert"}
						&#215
					Agenda Lotada		
		/%ul
		/- @atendimento.funcionario.errors.full_messages.each do |message|
		/	%li
		/		= message

	.row-fluid
		.span8
			%form.form-search
				.well.well-small
					= form_tag atendimentos_path, :class=>'form-horizontal',:controller=>'atendimentos', :method=>'get',:action=>'new',:remote=>true do 
						= select_tag :search, options_for_select(Funcionario.joins(:pessoa).order(:nome).map{|f| [f.pessoa.nome, f.id]}, :selected => params[:search]),{:id=>'selectFuncionario',:class=>"input-large", :prompt => "Selecione um funcionário" }
			
						.input-append.date.datepicker.no-padding
							= text_field_tag :date, params[:date],{:class=>'span7',:id=>'txtData'}
							%span.add-on
								%i.icon-th
							

						= button_tag(:type=> 'submit',:controller=>'atendimentos',:action=>'new',:name=>'getHorario',:class=>'btn btn-default',:id=>'btnCarregarAgenda',:rel=>'popover', :data=>{:html=>"true", :placement=>"top"}) do
							%i.icon-calendar
							Carregar Agenda
						

			= form_for @atendimento, :html => { :class => 'form-horizontal' } do |a|
				
				= a.hidden_field :data_at
				= a.hidden_field :funcionario_id
				.control-group
					= a.label 'Paciente', :class => 'control-label'
					.controls
						= a.collection_select(:paciente_id, Pessoa.joins(:paciente).order(:nome),:id,:nome,{:prompt=>true},:class=>'span10',:id=>'selectPaciente',:disabled=>true)

				.control-group
					= a.label 'Tipo de atendimento', :class => 'control-label'
					.controls
						= a.collection_select(:tipo_atendimento_id, @tipo_atendimentos,:id,:descricao,{:prompt=>true},{:id=>'selectTipoAtendimento',:disabled=>true})

						/= a.text_field :tipo_atendimento_id

				.control-group
					= a.label 'Horário', :class => 'control-label'
					.controls
						- if (@horarios.present?)
							= a.text_field :horario, :value=>timeFormat(@horarios.last.horario_fim),  :readonly=>'true',:class=>'span2',:id=>'txtHorario'
						- else
							= a.text_field :horario, :readonly=>'true'
							/= @atendimento.funcionario.ultimoHorarioDiaDeTrabalho(params[:date])
						//%button{:id=>'btnGetHorario', :type=>'button',:name=>'getHorario',:class=>'btn'} Obter horário
				
				
				
				.form-actions
					= a.submit 'Atualizar', :class => 'btn btn-primary', :disabled=>true
					= link_to t('.cancel', :default => t("helpers.links.cancel")), atendimentos_path, :class => 'btn'
		.span4
			=render 'get_horarios_livres'				

.modal.hide.fade{:id=>'modal-window', :role=>'dialog', 'aria-labelledby'=>'myModalLabel', 'aria-hidden'=>'true'}

%script{:src=>"/assets/jquery.js", :type=>"text/javascript"}
%script{:src=>"/assets/bootstrap-datepicker.js", :type=>"text/javascript"}
%script{:src=>"/assets/bootstrap-datepicker.pt-BR.js", :type=>"text/javascript"}
:javascript
	function habilitaForm(){
		$('#selectPaciente').attr('enabled','enabled');
	}
	$(document).ready(function (){
		//evitar conflito de versões
	    var $j = jQuery.noConflict();
		
		//Desabilita botão para carregar agenda caso não seja
		//informado o funcionario e a data
		if ($('#selectFuncionario,#txtData').val()===''){
			$('#btnCarregarAgenda').attr('disabled','disabled');
		}

	    $('#txtData').datepicker({
	    	autoclose: true,
	    	format: "dd/mm/yyyy",
	    	language: "pt-BR",
	    	startDate: new Date()
	    });

	    //copiar para o input text o que foi selecionado no select box
	    $('#selectFuncionario').change(function(){
	    	$('#txtFuncionario').text($('#selectFuncionario  option:selected').text());
	    })
	   
	   //Pegar último horário
	   $('#btnGetHorario').click(function(){
	   	//alert($('table tr:last td.horario_fim').text());
	   	$('#txtHorario').text($('table tr:last td.horario_fim').text());
	   })

	   // Popover para select do paciente
	   $('#selectPaciente').popover({
	   	//title: 'A title!',
	   	//trigger: 'hover',
	   	html : true,
	   	trigger: 'manual',
	   	delay: {
	   		show: "500",
	   		hide: "500"
	   	},
	   	content: 'Clique para escolher um paciente!'
	   });


	   // Popover para select do funcionario
	   $('#selectFuncionario').popover({
	   	//title: 'A title!',
	   	//trigger: 'hover',
	   	html : true,
	   	trigger: 'manual',
	   	delay: {
	   		show: "500",
	   		hide: "500"
	   	},
	   	content: 'Clique para escolher um funcionário!'
	   	});

	   	$('#selectTipoAtendimento').popover({
	   	//title: 'A title!',
	   	//trigger: 'hover',
	   	html : true,
	   	trigger: 'manual',
	   	delay: {
	   		show: "500",
	   		hide: "100"
	   	},
	   	content: 'Clique para escolher um tipo de consulta !'
	   	});

	   	//Popover no select funcionario caso tenha valor nulo
	   	$('#selectFuncionario').focus(function(){
	   		if ($('#selectFuncionario').val()===''){
	   			$('#selectFuncionario').popover('show');
	   		}
	   	}).focus();

	   	//Esconder Popover do select funcionario caso tenha valor
	   	$('#selectFuncionario').change(function(){
	   		if ($('#selectFuncionario')!=''){
	   			$('#selectFuncionario').popover('hide');
	   			$('#txtData').focus();
	   		}
	   	})
	   

	   	//Popover no select funcionario caso tenha valor nulo
	   	$('#txtData').focus(function(){
	   		if ($('#txtData').val()===''){
	   			$('#txtData').popover('show');
	   		}
	   	})

	   	$('#selectFuncionario').change(function(){
	   		//Verificando se valor é nulo
	   		if ($('#selectFuncionario').val()===''){
	   			$('#selectFuncionario').popover('show');
	   			//Desabilita o botão para carregar a agenda
	   			$('#btnCarregarAgenda').attr('disabled','disabled');
	   			//$('#selectFuncionario').focus();
	   			$('#selectPaciente').focus();
	   		}
	   		else{
	   			$('#btnCarregarAgenda').removeAttr('disabled');
	   			//$('#selectFuncionario').popover('hide');
	   			$('#selectPaciente').popover('hide');

	   		}
	   	});

		$('#selectPaciente').focus(function(){
			$('#selectPaciente').popover('show');
		});
		$('#selectPaciente').focusout(function(){
			$('#selectPaciente').popover('hide');
		});

		$('#selectTipoAtendimento').focus(function(){
			$('#selectTipoAtendimento').popover('show');
		});
		$('#selectTipoAtendimento').focusout(function(){
			$('#selectTipoAtendimento').popover('hide');
		});

		$('#btnCarregarAgenda').click(function(){
			$('#selectPaciente').focus();
	   	});

	   });



//= link_to "Buscar Data",horarioLivre_path,{:remote => true, 'data-toggle' =>  "modal", 'data-target' => '#modal-window'}